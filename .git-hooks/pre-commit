#!/usr/bin/env bash
# Pre-commit hook to run RuboCop linter

echo "Running RuboCop..."

# Get list of staged Ruby files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rb)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "No Ruby files staged for commit."
  exit 0
fi

# Run RuboCop on staged files, suppress warnings, only check for offenses
bundle exec rubocop $STAGED_FILES 2>&1 | grep -v "^Warning:" | grep -E "(offense|^Inspecting|^$|^RSpec)" || true

# Check if RuboCop found offenses by checking exit code of the actual rubocop command
if ! bundle exec rubocop $STAGED_FILES --format quiet 2>/dev/null; then
  echo ""
  echo "RuboCop found violations. Run 'bundle exec rubocop --autocorrect-all' to fix."
  echo "Or commit with --no-verify to skip this check (not recommended)."
  exit 1
fi

echo "RuboCop passed!"
exit 0
